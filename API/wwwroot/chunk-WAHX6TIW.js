import{a as $,b as ee}from"./chunk-HKUEPVDT.js";import{a as ce}from"./chunk-6ZET53GP.js";import{b as te,f as re,i as ne,n as ie,o as oe,p as ae,q as se,r as le,y as pe}from"./chunk-2ZW3YYFG.js";import{b as de}from"./chunk-AJ5XW3XI.js";import{$b as K,Db as S,Eb as C,Hc as Y,Jb as k,K as F,Ka as O,La as U,N as D,Q as E,Qa as T,Ra as a,Sa as s,U as d,W as q,X as B,Xb as H,_a as G,ab as j,cb as R,cc as x,d as c,da as L,gd as Z,jc as Q,mc as g,na as m,qb as l,r as v,rb as I,s as w,sb as A,ub as z,va as W,vb as J,wb as X}from"./chunk-YHFUIHAH.js";var me="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";var ue=(i=21)=>{let e="",t=crypto.getRandomValues(new Uint8Array(i|=0));for(;i--;)e+=me[t[i]&63];return e};function fe(){return{id:ue(),items:[],deliveryMethodId:void 0,paymentIntentId:void 0,clientSecret:void 0}}var h=class i{baseURL=g.apiURL;shoppingCart=L(null);deliveryMethod=L(null);itemCount=k(()=>this.shoppingCart()?.items.reduce((e,t)=>e+t.quantity,0));totals=k(()=>{let e=this.shoppingCart(),t=this.deliveryMethod();if(!e)return null;let r=e.items.reduce((f,u)=>f+u.price*u.quantity,0),n=t?t.price:0,o=0,p=e.coupon;return p&&(p.percentOff?o=r*(p.percentOff/100):p.amountOff&&(o=p.amountOff/100)),{subTotal:r,shipping:n,discount:o,total:r+n-o}});http=d(x);getCart(e){return this.http.get(this.baseURL+"cart?id="+e).pipe(w(t=>(this.shoppingCart.set(t),t)))}deleteCart(){return this.http.delete(this.baseURL+"cart?id="+this.shoppingCart()?.id).subscribe({next:()=>{localStorage.removeItem("cart_id"),this.shoppingCart.set(null)}})}setCart(e){return this.http.post(this.baseURL+"cart",e).pipe(D(t=>{this.shoppingCart.set(t)}))}addItemToCart(e,t=1){return c(this,null,function*(){let r=this.shoppingCart()??this.createCart();this.isProduct(e)&&(e=this.mapProductToCartItem(e)),r.items=this.addOrUpdateItem(r.items,e,t),yield v(this.setCart(r))})}removeItemFromCart(e,t=1){return c(this,null,function*(){let r=this.shoppingCart();if(!r)return;let n=r.items.findIndex(o=>o.productId===e.productId);n!==-1&&(r.items[n].quantity>t?r.items[n].quantity-=t:r.items.splice(n,1),r.items.length===0?this.deleteCart():yield v(this.setCart(r)))})}addOrUpdateItem(e,t,r){let n=e.findIndex(o=>o.productId===t.productId);return n===-1?(t.quantity=r,e.push(t)):e[n].quantity+=r,e}mapProductToCartItem(e){return{productId:e.id,productName:e.name,price:e.price,quantity:0,pictureURL:e.pictureUrl,brand:e.brand,type:e.type}}isProduct(e){return e.id!==void 0}createCart(){let e=fe();return localStorage.setItem("cart_id",e.id),e}validateCoupon(e){return this.http.get(this.baseURL+"coupons/"+e)}static \u0275fac=function(t){return new(t||i)};static \u0275prov=E({token:i,factory:i.\u0275fac,providedIn:"root"})};var Ce="clover",Ie=function(e){return e===3?"v3":e},ge="https://js.stripe.com",xe="".concat(ge,"/").concat(Ce,"/stripe.js"),_e=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,Pe=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/,ve="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",Me=function(e){return _e.test(e)||Pe.test(e)},Le=function(){for(var e=document.querySelectorAll('script[src^="'.concat(ge,'"]')),t=0;t<e.length;t++){var r=e[t];if(Me(r.src))return r}return null},Se=function(e){var t=e&&!e.advancedFraudSignals?"?advancedFraudSignals=false":"",r=document.createElement("script");r.src="".concat(xe).concat(t);var n=document.head||document.body;if(!n)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return n.appendChild(r),r},Oe=function(e,t){!e||!e._registerWrapper||e._registerWrapper({name:"stripe-js",version:"8.3.0",startTime:t})},y=null,_=null,P=null,Ue=function(e){return function(t){e(new Error("Failed to load Stripe.js",{cause:t}))}},Te=function(e,t){return function(){window.Stripe?e(window.Stripe):t(new Error("Stripe.js not available"))}},je=function(e){return y!==null?y:(y=new Promise(function(t,r){if(typeof window>"u"||typeof document>"u"){t(null);return}if(window.Stripe&&e&&console.warn(ve),window.Stripe){t(window.Stripe);return}try{var n=Le();if(n&&e)console.warn(ve);else if(!n)n=Se(e);else if(n&&P!==null&&_!==null){var o;n.removeEventListener("load",P),n.removeEventListener("error",_),(o=n.parentNode)===null||o===void 0||o.removeChild(n),n=Se(e)}P=Te(t,r),_=Ue(r),n.addEventListener("load",P),n.addEventListener("error",_)}catch(p){r(p);return}}),y.catch(function(t){return y=null,Promise.reject(t)}))},Re=function(e,t,r){if(e===null)return null;var n=t[0],o=n.match(/^pk_test/),p=Ie(e.version),f=Ce;o&&p!==f&&console.warn("Stripe.js@".concat(p," was loaded on the page, but @stripe/stripe-js@").concat("8.3.0"," expected Stripe.js@").concat(f,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var u=e.apply(void 0,t);return Oe(u,r),u},b,ye=!1,be=function(){return b||(b=je(null).catch(function(e){return b=null,Promise.reject(e)}),b)};Promise.resolve().then(function(){return be()}).catch(function(i){ye||console.warn(i)});var we=function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];ye=!0;var n=Date.now();return be().then(function(o){return Re(o,t,n)})};var M=class i{baseUrl=g.apiURL;cartService=d(h);accountService=d(de);stripePromise;elements;addressElement;paymentElement;http=d(x);constructor(){this.stripePromise=we(g.stripePublicKey)}getStripeInstance(){return this.stripePromise}initializeElements(){return c(this,null,function*(){if(!this.elements){let e=yield this.getStripeInstance();if(e){let t=yield v(this.createOrUpdatePaymentIntent());this.elements=e.elements({clientSecret:t.clientSecret,appearance:{labels:"floating"}})}else throw new Error("Stripe has not been loaded")}return this.elements})}createPaymentElement(){return c(this,null,function*(){if(!this.paymentElement){let e=yield this.initializeElements();if(e)this.paymentElement=e.create("payment");else throw new Error("Elements instance has not been initialized")}return this.paymentElement})}createAddressElement(){return c(this,null,function*(){if(!this.addressElement){let e=yield this.initializeElements();if(e){let t=this.accountService.currentUser(),r={};t&&(r.name=t.firstName+" "+t.lastName),t?.address&&(r.address={line1:t.address.line1,line2:t.address.line2,city:t.address.city,state:t.address.state,postal_code:t.address.postalCode,country:t.address.country});let n={mode:"shipping",defaultValues:r};this.addressElement=e.create("address",n)}else throw new Error("Elements instance has not been loaded")}return this.addressElement})}createConfirmationToken(){return c(this,null,function*(){let e=yield this.getStripeInstance(),t=yield this.initializeElements(),r=yield t.submit();if(r.error)throw new Error(r.error.message);if(e)return yield e.createConfirmationToken({elements:t});throw new Error("Stripe not available")})}confirmPayment(e){return c(this,null,function*(){let t=yield this.getStripeInstance(),n=yield(yield this.initializeElements()).submit();if(n.error)throw new Error(n.error.message);let o=this.cartService.shoppingCart()?.clientSecret;if(t&&o)return yield t.confirmPayment({clientSecret:o,confirmParams:{confirmation_token:e.id},redirect:"if_required"});throw new Error("Unable to load stripe")})}createOrUpdatePaymentIntent(){let e=this.cartService.shoppingCart();if(!e)throw new Error("Problem with cart!");return this.http.post(`${this.baseUrl}payment/${e.id}`,{}).pipe(F(t=>this.cartService.setCart(t).pipe(w(()=>t))))}disposeElements(){this.elements=void 0,this.addressElement=void 0,this.paymentElement=void 0}static \u0275fac=function(t){return new(t||i)};static \u0275prov=E({token:i,factory:i.\u0275fac,providedIn:"root"})};function Ae(i,e){i&1&&(a(0,"div",9)(1,"button",17),l(2,"Checkout"),s(),a(3,"button",18),l(4,"Continue Shopping"),s()())}function ke(i,e){if(i&1){let t=G();a(0,"label",13),l(1),a(2,"mat-icon",19),j("click",function(){q(t);let n=R();return B(n.removeCouponCode())}),l(3,"close"),s()()}if(i&2){let t,r=R();m(),A("",(t=r.cartService.shoppingCart())==null||t.coupon==null?null:t.coupon.name," ")}}var Ee=class i{cartService=d(h);stripeService=d(M);location=d(H);voucherCode="";applyCouponCode(){let e=this.cartService.shoppingCart();e!==null&&this.cartService.validateCoupon(this.voucherCode).subscribe({next:t=>c(this,null,function*(){t&&(e.coupon=t,console.log(e.coupon),this.cartService.setCart(e).subscribe({next:()=>c(this,null,function*(){(yield this.stripeService.getStripeInstance())&&this.stripeService.createOrUpdatePaymentIntent().subscribe({error:n=>console.log(n)})})}))}),error:t=>console.log(t)})}removeCouponCode(){let e=this.cartService.shoppingCart();e!==null&&(e.coupon=void 0,this.cartService.setCart(e).subscribe({next:()=>c(this,null,function*(){(yield this.stripeService.getStripeInstance())&&this.stripeService.createOrUpdatePaymentIntent().subscribe({error:r=>console.log(r)})}),error:t=>console.log(t)}))}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=W({type:i,selectors:[["app-order-summary"]],decls:42,vars:17,consts:[[1,"mx-auto","max-w-4xl","flex-1","space-y-6","w-full"],[1,"space-y-4","rounded-lg","border","border-gray-200","shadow-sm","p-4"],[1,"text-xl","font-semibold"],[1,"space-y-4"],[1,"space-y-2"],[1,"flex","items-center","justify-between","gap-4"],[1,"font-medium"],[1,"font-medium","text-green-500"],[1,"flex","items-center","justify-between","gap-4","border-top","border-gray-200","pt-2"],[1,"flex","flex-col","gap-2"],[1,"space-y-4","rounded-lg","border","border-gray-200","shadow-sm"],[1,"space-y-2","flex","flex-col","p-2"],[1,"mb-2","block","text-sm","font-medium"],[1,"text-green-500"],["appearance","outline"],["type","text","matInput","","name","voucherCode",3,"ngModelChange","disabled","ngModel"],["mat-flat-button","",3,"click","disabled"],["routerLink","/checkout","mat-flat-button",""],["routerLink","/shop","mat-button",""],[1,"text-red-500","cursor-pointer",3,"click"]],template:function(t,r){if(t&1&&(a(0,"div",0)(1,"div",1)(2,"p",2),l(3,"Order Summary"),s(),a(4,"div",3)(5,"div",4)(6,"dl",5)(7,"dt",6),l(8,"Subtotal"),s(),a(9,"dd",6),l(10),S(11,"currency"),s()(),a(12,"dl",5)(13,"dt",6),l(14,"Discount"),s(),a(15,"dd",7),l(16),S(17,"currency"),s()(),a(18,"dl",5)(19,"dt",6),l(20,"Delivery Fee"),s(),a(21,"dd",6),l(22),S(23,"currency"),s()()(),a(24,"dl",8)(25,"dt",6),l(26,"Total"),s(),a(27,"dd",6),l(28),S(29,"currency"),s()()(),O(30,Ae,5,0,"div",9),s(),a(31,"div",10)(32,"form",11)(33,"label",12),l(34," Do you have a voucher code? "),s(),O(35,ke,4,1,"label",13),a(36,"mat-form-field",14)(37,"mat-label"),l(38,"Voucher Code"),s(),a(39,"input",15),X("ngModelChange",function(o){return J(r.voucherCode,o)||(r.voucherCode=o),o}),s()(),a(40,"button",16),j("click",function(){return r.applyCouponCode()}),l(41,"Apply Code"),s()()()()),t&2){let n,o,p,f,u,N,V;m(10),I(C(11,9,(n=r.cartService.totals())==null?null:n.subTotal)),m(6),A("-",C(17,11,(o=r.cartService.totals())==null?null:o.discount)),m(6),I(C(23,13,(p=r.cartService.totals())==null?null:p.shipping)),m(6),I(C(29,15,(f=r.cartService.totals())==null?null:f.total)),m(2),U(r.location.path()!=="/checkout"?30:-1),m(5),U((u=r.cartService.shoppingCart())!=null&&u.coupon?35:-1),m(4),T("disabled",!!((N=r.cartService.shoppingCart())!=null&&N.coupon)),z("ngModel",r.voucherCode),m(),T("disabled",!!((V=r.cartService.shoppingCart())!=null&&V.coupon))}},dependencies:[Z,Q,re,te,ce,pe,le,ne,ie,oe,se,ae,Y,ee,$,K],encapsulation:2})};export{h as a,M as b,Ee as c};
